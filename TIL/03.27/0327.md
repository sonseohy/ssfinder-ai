# [03.27] 분실물 등록 AI 완성

## 분실물 등록 AI BLIP 테스트
### blip_fastapi_ko.py

#### 문제점
[ ] 핸드폰에서 색상을 추출할 때 폰케이스가 있는 경우 BLIP 영어 이미지캡셔닝에서 폰케이스를 인식하지만 색상 추출 시 폰케이스 색상으로 결과를 추출함
[v] 헤드셋 사진 분석 결과가 로그에 찍히는 영어 캡셔닝은 헤드폰을 인식하지만 이후 과정에 문제가 있는지 결과는 휴대폰으로 나옴
[ ] distinctive_feature 응답이 영어로 오고 특징을 잘 추출하는 영어 캡셔닝이 아닌 것으로 보임 (ex. buttons..)
[ ] 한국어 번역해서 json 결과를 낼 때 영어 이미지 캡셔닝과의 차이가 느껴짐 
[v] 코드가 너무 길고 fast api를 아래에 붙이는게 맞는지 모르겠음 → 역할별 파일로 구분
[v] 한국어 번역 방식이 번역이 아닌 정의된 딕셔너리에서의 매핑 방식이라 특징의 경우는 영어로 나옴 → 파파고 API 도입
[ ] 차 키 사진은 아예 못알아봄
[ ] BLIP 모델의 영어 캡션 결과로 samsung galaxy note 10 lite 같이 구체적인 기기명이 나와버리는 경우 스마트폰으로 인식을 못함
[ ] 색상 분류 이슈: tan 이라고 베이지색 계열 색상을 영어로 추출했는데 번역했더니 이상해짐
[ ] 핸드폰 잠금화면이 켜진 사진의 경우도 핸드폰 색상을 해당 배경 색상으로 하는 경향 있음
[ ] 번역을 하니까 애플 제품을 사과 제품으로 설명하는 이슈 발생

### blip_fastapi_ko2.py
- blip_fastapi_ko 모델의 이슈 해결

#### 이슈 및 해결방향
- [v] blip_fastapi_ko.py 코드를 Fast API 코드, 모델 코드, 번역 코드, 설정 코드로 나눠 작성 → register_ai에 정리

- 이슈 2. 헤드셋에서 뽑은 키워드 found_keywords 목록을 보면 "phone", "headphones", "id"가 모두 발견 → if keyword in caption.lower() 조건에서 "phone" 키워드도 매치 (매핑 딕셔너리를 순회하면서 첫 번째로 매치되는 키워드를 반환)
    - 해결 1. 정확한 단어 매칭 사용: 부분 문자열이 아닌 전체 단어가 매치되는지 확인
    - 해결 2. 긴 키워드 우선 검사: 더 구체적인(더 긴) 키워드를 먼저 검사
    ```python
        def extract_category_from_caption(self, caption):
            caption_lower = caption.lower()
            words = caption_lower.split()
            
            print(f"### DEBUG: Words in caption: {words}")
            
            # 키워드를 길이 순으로 정렬 (긴 것이 먼저)
            sorted_keywords = sorted(self.category_mapping.keys(), key=len, reverse=True)
            
            # 각 매핑된 키워드를 확인
            for keyword in sorted_keywords:
                # 전체 단어 매칭 또는 복합어 검사
                if keyword in words or (len(keyword.split()) > 1 and keyword in caption_lower):
                    print(f"### DEBUG: Found keyword '{keyword}' -> category '{self.category_mapping[keyword]}'")
                    return self.category_mapping[keyword]
            
            print("### DEBUG: No category found in caption")
            return ""
    ```

- 추가 이슈. 카테고리는 "전자기기"로 올바르게 매핑되었지만, 제목과 설명에는 여전히 "휴대폰"이 사용
- 원인
    1. _generate_title 함수에서 제품명을 추출하는 과정에서 "headphones"를 제대로 인식하지 못하고 있음
    2. 제목 생성 후 번역 과정에서 "phone"이 매핑되어 "휴대폰"으로 번역되고 있음

    - 해결
    1. _generate_title 함수에서 제품명 추출 로직 개선
        ```python
        def _generate_title(self, answers: Dict[str, str], caption: str, category: str, brand: str) -> str:
            # 색상 추출
            color = answers["color"].lower()
            
            # 상품 이름 추출 시도 (캡션에서 핵심 단어 추출)
            product_name = ""
            
            # 디버깅: 제품명 추출 과정 로깅
            print(f"### DEBUG: Extracting product name from caption: {caption}")
            
            # 정확한 단어 매칭을 위해 캡션을 단어로 분리
            caption_words = caption.lower().split()
            
            common_items = ["headphones", "earphones", "ipad", "iphone", "macbook", "laptop", "phone", 
                        "tablet", "watch", "airpods", "wallet", "bag", "umbrella", "camera", 
                        "book", "glasses"]
            
            # 단어 단위로 정확하게 매칭
            for item in common_items:
                if item in caption_words:
                    product_name = item
                    print(f"### DEBUG: Found product name: {product_name}")
                    break
            
            # 제목 생성
            if product_name:
                # 제품명이 발견되면 이를 사용
                title = f"{color} {product_name}"
            elif category:
                # 카테고리 사용
                title = f"{color} {category}"
            else:
                # 둘 다 없는 경우 일반적 항목으로
                title = f"{color} item"
                
            # 브랜드 추가 (있는 경우)
            if brand and brand.lower() not in title.lower():
                title = f"{brand} {title}"
                
            print(f"### DEBUG: Generated title: {title}")
            return title
        ```
    2. 번역 과정에서 정확한 제품명 매핑 확인
        ```python
        def _translate_results(self, caption: str, title: str, description: str, 
                    category: str, color: str, material: str, 
                    brand: str, distinctive_features: str) -> Dict[str, str]:
            # ... 기존 코드 ...
            
            # 제목에서 제품 찾기 - 정확한 단어 매칭 사용
            product_found = False
            title_words = title.lower().split()
            
            print(f"### DEBUG: Title words: {title_words}")
            
            for en_item, ko_item in common_items_ko.items():
                if en_item in title_words:
                    translated_title += ko_item
                    product_found = True
                    print(f"### DEBUG: Found product '{en_item}' in title, translating to '{ko_item}'")
                    break
            
            # ... 나머지 코드 ...
        ```

### blip_papago.py
- 매핑 코드를 줄이고 특징이 영어로 나오는 부분을 해결하기 위해 파파고 API 도입
- 영어 캡셔닝된 특징을 한국어로 바꾸고 description에 "특징은~ " 으로 나오도록 하여 설명을 보완

#### 수정한 코드
```python
# 결과 한국어 번역
    def _translate_results(self, caption: str, title: str, description: str, 
                     category: str, color: str, material: str, 
                     brand: str, distinctive_features: str) -> Dict[str, str]:
        
        # 카테고리 번역 (매핑 사용)
        translated_category = self.category_translation.get(category.lower(), category)
        if translated_category == category and self.use_papago:
            # 매핑에 없는 경우 파파고 사용
            translated_category = self.papago_translate(category)
        
        # 색상 번역 (파파고 사용)
        if self.use_papago:
            translated_color = self.papago_translate(color)
        else:
            translated_color = color
        
        # 재질 번역 (파파고 사용)
        if self.use_papago:
            translated_material = self.papago_translate(material)
        else:
            translated_material = material
        
        # 브랜드 번역 (매핑 사용, 브랜드는 보통 번역하지 않음)
        translated_brand = self.brand_translation.get(brand.lower() if brand else "", brand if brand else "")
        
        # 제목 생성
        # 색상과 브랜드로 시작
        if translated_brand:
            translated_title = f"{translated_brand} {translated_color} "
        else:
            translated_title = f"{translated_color} "
        
        # 제품명 추가
        title_words = title.lower().split()
        product_found = False
        
        for en_item, ko_item in self.product_translation.items():
            if en_item in title_words:
                translated_title += ko_item
                product_found = True
                break
        
        # 제품이 없으면 카테고리 사용
        if not product_found:
            translated_title += translated_category
        
        # 특이사항 번역 (파파고 사용)
        if self.use_papago and distinctive_features:
            translated_features = self.papago_translate(distinctive_features)
        else:
            translated_features = distinctive_features
        
        # 설명 번역 - 항상 간결한 한국어 형식 사용
        translated_description = f"이 물건은 {translated_material} 재질의 {translated_color} {translated_category}입니다."
        
        # 특이사항이 있으면 추가
        if translated_features and "unknown" not in translated_features.lower() and "none" not in translated_features.lower():
            translated_description += f" 특징은 {translated_features} 입니다."
        
        # 결과 반환
        return {
            "title": translated_title,
            "category": translated_category,
            "color": translated_color,
            "material": translated_material,
            "brand": translated_brand,
            "description": translated_description.strip(),
            "distinctive_features": translated_features
        }
```


### 파일
- .env : 파파고 API key 필요