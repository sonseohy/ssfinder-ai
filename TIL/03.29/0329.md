# [03.29] 분실물 매칭 AI 구현 : 파이프라인 구상 및 CLIP 모델 테스트

## 분실물 매칭 AI 파이프라인
- CLIP 모델 기반으로 게시글간 유사도 비교
- 사용자가 분실물 정보 등록 → FastAPI 서버 → AI 모델 서버 (임베딩 생성) → Spark 작업 (유사도 계산) → MySQL 검색 결과 저장 → 사용자 응답 반환
- 알림의 경우 Spark 작업이 끝나고 임계값 초과 시 FCM 알림 발송

### 전체 시스템 아키텍처
1. 사용자 인터페이스
    - 사용자가 분실물 정보 (이미지 + 텍스트) 등록
2. FastAPI 백엔드 서버
    - 사용자 요청 처리 및 응답 제공
    - 알림 서비스 관리
3. AI 모델 서버
    - CLIP 모델로 이미지 + 텍스트 임베딩 생성
    - FastAPI로 REST API 엔드 포인트 제공
4. Spark 클러스터
    - 대규모 임베딩 유사도 계산
    - 습득물 데이터 처리
    - 분산 매칭 작업 수행
5. MySQL DB
    - 습득물 데이터 및 임베딩 저장 (임베딩은 엘라스틱 서치에 저장)
    - 매칭 결과 저장
6. FCM
    - 매칭 결과 사용자 알림 전송

### 주요 컴포넌트 상세 설명
1. Fast API 백엔드 서버
    - 비동기 요청 처리로 고성능 제공
    -  API 엔드포인트:
        - /lost-items - 분실물 등록
        - /found-items - 습득물 데이터 조회
    - 습득물 DB 스케줄러 작업 관리
    - 알림 트리거 및 발송 관리
2. AI 모델 서버 (FastAPI)
    - CLIP 모델 로드 및 서빙
    - 주요 엔드포인트:
        - /embedding - 이미지+텍스트 임베딩 생성
    - 배치 처리 최적화
    - Pydantic 모델로 입출력 검증
3. Spark 분산 처리 시스템
    - 클러스터 구성:
        - 마스터 노드: 작업 관리 및 조정
        - 워커 노드: 분산 계산 수행
    - 주요 작업:
        - 벡터 유사도 계산 작업
        - AI 모델 서버 API 호출로 임베딩 획득
        - 경찰청 데이터 일괄 처리
        - 매칭 결과 MySQL 저장
4. MySQL 데이터베이스
    - 주요 테이블:
        - found_items - 경찰청 습득물 데이터 및 임베딩
        - matches - 분실물-습득물 매칭 결과
        - notifications - 발송된 알림 기록
5. FCM 알림 서비스
    - FCM 토큰 관리

### 시스템 작동 시나리오
- 시나리오 1: 사용자가 분실물 검색
    1. 사용자가 분실물 이미지와 설명을 업로드
    2. FastAPI 서버가 이 정보를 AI 모델 서버로 전송
    3. AI 모델 서버가 CLIP으로 통합 임베딩 생성 후 반환
    4. FastAPI가 Spark 작업을 트리거하여 습득물 데이터와 유사도 계산
    5. Spark가 상위 N개 매칭 결과를 MySQL에 저장
    6. FastAPI가 결과를 사용자에게 반환
- 시나리오 2: 경찰청 API 새 습득물 등록
    1. FastAPI 스케줄러가 경찰청 API에서 새 습득물 데이터 수집
    2. 각 습득물 데이터를 AI 모델 서버로 전송하여 임베딩 생성
    3. 습득물 정보와 임베딩을 MySQL에 저장
    4. Spark 작업을 트리거하여 모든 알림 구독자의 분실물과 유사도 계산
    5. 임계값(80%) 이상 유사도를 가진 매치에 대해 FCM 알림 발송


### clip_api.py
- CLIP 모델 테스트를 경찰청 api를 불러와서 테스트 할 수 있는 코드

- 카테고리 매칭 강화
    - 같은 카테고리일 경우 50% 보너스: CATEGORY_MATCH_BONUS = 0.5
    - 다른 카테고리일 경우 30% 페널티: CATEGORY_MISMATCH_PENALTY = 0.3

#### 문제점
- 카테고리 매칭 보너스와 패널티를 적용하다보니 일반적인 코사인 유사도에서 벗어나는 값 (-1 ~ 1 사이 값이 아닌 값)이 결과로 나옴
- 기술적으로는 "표준화되지 않은 유사도 점수"라고 볼 수 있으며, 순수한 코사인 유사도가 아님. 이는 결국 항목들의 상대적 순위를 결정하는 데 사용되는 "점수"에 가깝게 측정됨
- 단순히 항목 간의 순위를 정하는 것이 목적이라면, 점수가 1을 초과하더라도 상대적 순서만 맞다면 문제가 되지 않을 수 있긴 함

### clip_cos.py
- clip_api.py 코드의 매칭 보너스에 대한 문제를 해결하고자 순수 코사인 유사도를 유지하는 코드로 작성
- 순수 코사인 유사도를 유지하면서 의미적 연관성을 함께 활용하는 방법은 아래와 같음음
    1. 순위 재조정 방식
        - 먼저 순수 코사인 유사도로 초기 순위를 매김
        - 이후 카테고리 매칭 여부나 기타 메타 데이터를 기반으로 순위 재조정
    2. 병렬 점수 시스템
        - 순수 코사인 유사도와 카테고리 점수를 별도로 계산
        - 최종 결과를 보여줄 때 두 점수 함께 표시
    3. 앙상블 검색 방식
        - 텍스트 기반 검색, 이미지 기반 검색, 카테고리 기반 검색을 각각 수행
        - 각 검색 결과를 조합하여 최종 순위를 결정함

### clip_cos+mean.py
- 순수 코사인 유사도를 유지하면서 의미적 연관성을 함께 활용하는 방안의 코드
- 최종 구현
    1. 순수 코사인 유사도 계산 :  CLIP 모델로 텍스트오 이미지의 순수 코사인 유사도 계산
    2. 결과 필터링 : 코사인 유사도가 특정 임계값 이상인 아이템만 선택
    3. 결과 그룹화 : 선택된 아이템을 카테고리별로 그룹화
    4. UI에 표시 : 사용자에게 결과를 카테고리별로 보여주고, 각 카테고리 내에서는 코사인 유사도에 따라 정렬