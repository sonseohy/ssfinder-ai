# [03.27] 분실물 등록 AI 폴더 구조 변경 및 코드 리팩토링

## 분실물 등록 AI 폴더 구조 변경 및 코드 리팩토링

### img_analyze_ai
- 프로젝트에 맞게 폴더 구조 수정 및 이에 따른 코드 리팩토링 진행

#### app/main.py
- 기존의 이벤트 처리 방식인 @app.on_event("startup")을 최신 수명 주기관리 방식인 Lifespan으로 변경
- 기존의 @app.on_event("startup") 데코레이터를 대체하는 lifespan 컨텍스트 매니저를 추가

```python
# 기존 이벤트 처리 방식

# 앱 시작시 실행되는 이벤트 핸들러
@app.on_event("startup")
async def startup_event():
    global analyzer
    analyzer = LostItemAnalyzer()
    print("분실물 분석 ai가 초기화되었습니다.")

```

```python
# Lifespan으로 변경
from contextlib import asynccontextmanager

# lifespan 컨텍스트 매니저 추가
@asynccontextmanager
async def lifespan(app: FastAPI):
    # 앱 시작 시 실행
    global analyzer
    analyzer = LostItemAnalyzer()
    print("분실물 분석 ai가 초기화되었습니다.")
    
    yield  # 애플리케이션 실행 지점
    
    print("분실물 분석 ai가 종료되었습니다.")
```

#### Lifespan
- FastAPI에서 lifespan은 애플리케이션 실행 전후에 특정 작업을 수행할 수 있게 해주는 기능
- Lifespan은 FastAPI 애플리케이션의 수명 주기 관리를 위한 최신 방식
- 간단히 말해서, 애플리케이션이 시작될 때와 종료될 때 실행되어야 하는 코드를 관리하는 메커니즘
1. 시작 시 수행할 작업:
    - 데이터베이스 연결 설정
    - 모델 로딩
    - 캐시 초기화
    - 외부 서비스 연결 등
2. 종료 시 수행할 작업:
    - 데이터베이스 연결 종료
    - 자원 해제
    - 임시 파일 정리 등
- 기존 방식(on_event)과 차이점
    - FastAPI에서는 이전에 @app.on_event("startup")과 @app.on_event("shutdown") 데코레이터를 사용하여 이러한 이벤트를 처리
    - BUT. 이제는 lifespan 컨텍스트 매니저가 권장됨
    - 주요 장점
        1. 더 명확한 에러 처리
        2. 더 나은 비동기 지원 (비동기 컨텍스트에서 더 안정적으로 작동)
        3. Starlette 및 ASGI 표준과의 더 나은 호환성
        4. 코드의 가독성 향상 (시작 및 종료 코드가 하나의 함수에 함께 있음)


### 수정사항
- img_analyze_router.py : 업로드하는 파일 확장자 검증 추가 코드 추가
```python
# 파일 확장자 검증
    valid_extensions = ['.jpg', '.jpeg', '.png', '.bmp', '.gif']
    file_ext = os.path.splitext(file.filename)[1].lower()
    
    if file_ext not in valid_extensions:
        raise HTTPException(
            status_code=400, 
            detail=f"지원되지 않는 파일 형식입니다. 지원되는 형식: {', '.join(valid_extensions)}"
        )
```