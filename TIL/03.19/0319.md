# [03.19] CLIP zeroshot 이미지 분류 모델 테스트

## clip_zeroshot_v1
- 초기 설정
- 게시글의 텍스트와 이미지 비율을 7:3으로 해서 텍스트 비율을 높게 설정
- 한국어 텍스트에 최적화 된 한국어 CLIP 모델 사용 : [Bingsu/clip-vit-large-patch14-ko](https://huggingface.co/Bingsu/clip-vit-large-patch14-ko)

### 문제점
1. 텍스트 비율이 높아 강아지와 지갑 이미지를 비교했을때도 유사도가 약 0.69로 측정되어 유사 게시글로 판별되어 결과 제공
2. 관련 없는 물건들의 비교도 유사도 높음 → 유사도 측정 기준, 비율 기준을 잘 모르겠다.

### 해결방향
1. 텍스트와 이미지 비율을 3:7로 변경하여 이미지 비율을 높게 설정 → 강아지와 지갑의 유사도가 낮아 유사 게시글로 나오지 않음
2. 아래 코드가 가중치를 부여하는 코드
```python
combined_embedding = 0.3 * text_embedding + 0.7 * image_embedding
```

## clip_zeroshot_v2
- 같은 카테고리일 때 유사도가 측정되고 다른 카테고리일 경우 텍스트가 같더라도 유사도가 0으로 측정되도록 수정
```python
# 유사도 계산 함수 수정
def calculate_similarity(self, post1, post2):

        # 아래 조건문 추가
        # 둘 다 이미지가 있는 경우, 이미지 유사도 먼저 계산
        if post1.get('image_path') and post2.get('image_path'):
            try:
                # 이미지만 추출하여 유사도 계산
                image1 = Image.open(post1['image_path'])
                image2 = Image.open(post2['image_path'])
                
                inputs1 = self.processor(images=image1, return_tensors="pt").to(self.device)
                inputs2 = self.processor(images=image2, return_tensors="pt").to(self.device)
                
                with torch.no_grad():
                    image_embedding1 = self.model.get_image_features(**inputs1).cpu().numpy()[0]
                    image_embedding2 = self.model.get_image_features(**inputs2).cpu().numpy()[0]
                    
                    # 이미지 유사도 계산
                    image_similarity = cosine_similarity([image_embedding1], [image_embedding2])[0][0]
                    
                    # 이미지 유사도가 매우 낮으면 (다른 카테고리로 판단) 낮은 유사도 반환
                    if image_similarity < 0.2:  # 이미지 카테고리 임계값
                        return 0.0
            except Exception as e:
                print(f"이미지 유사도 계산 중 오류: {e}")
        
        # 일반적인 유사도 계산 (텍스트+이미지 결합)
        embedding1 = self.get_post_embedding(post1)
        embedding2 = self.get_post_embedding(post2)
        
        # 카테고리 일치 여부 확인 (텍스트 기반)
        if post1.get('category') and post2.get('category') and post1['category'] != post2['category']:
            return 0.1  # 카테고리가 다르면 낮은 유사도
        
        # 코사인 유사도 계산
        similarity = cosine_similarity([embedding1], [embedding2])[0][0]
        return similarity
```
- ver2 코드에 대해 GPU 환경과 CPU 환경 모두 돌려봤을때 시간초 차이가 약 1초 차이로 미미함 (GPU : 3.29초, CPU : 4.18초) → 게시글이 적어서 그럴 수도 있으므로 향후 확인

### 문제점
1. 검정색 장지갑과 유사한 이미지로 판별될만한 가죽소재 수첩을 기존 게시글과 비교했을때 수첩과 지갑의 카테고리가 다름에도 유사게시글로 지갑 게시글을 제공
    - 텍스트에 대한 파인튜닝도 진행해야 할까?
2. 이미지가 없는 게시글과 내가 올린 게시글의 비교에서 카테고리와 설명이 유사해도 둘을 유사한 게시글로 찾지 못함
    ```python
        # 테스트용 한국어 게시글 데이터
        existing_posts = [
            {
                "image_path": "sample_images/wallet1.jpg",
                "description": "검은색 루이비통 장지갑",
                "category": "지갑",
                "storage_location": "쌍문파출소",
                "condition": "보관중",
                "found_location": "세그루패션고등학교"
            },
            {
                "image_path": None,
                "description": "파란색 우산, 자동 접이식",
                "category": "우산",
                "storage_location": "학생회관",
                "condition": "보관중",
                "found_location": "공학관 로비"
            }
        ]
        
        new_post = {
            "image_path": "sample_images/blueumb.jpg",
            "description": "파란색 우산",
            "category": "우산",
            "condition": "분실",
            "found_location": "도서관"
        }
    ```
    - 확인 결과 0.65 이상의 게시글을 유사 게시글로 판단하는데 두 게시글의 유사도 분석 결과가 0.5356
    - But. 내가 올린 게시글도 이미지가 없다면 유사도가 0.8798로 유사 게시글로 판단되어 제공됨
    - Claude : 기존 게시글에는 사진이 없고, 내가 올린 게시글에 사진이 있다면 두 게시글 유사도를 어떻게 계산하는지?
        ```
            get_post_embedding 함수는 이미지 유무에 따라 다르게 작동합니다:
                이미지가 있으면 텍스트와 이미지를 3:7 비율로 결합한 임베딩을 반환합니다.
                이미지가 없으면 텍스트만으로 임베딩을 생성합니다.

            질문한 시나리오에서:
                사진이 있는 새 게시글 → 텍스트와 이미지를 3:7 비율로 결합한 임베딩 사용
                사진이 없는 기존 게시글 → 텍스트만으로 생성된 임베딩 사용

            이런 불균형한 상황에서는 서로 다른 차원의 공간에서 임베딩을 비교하게 되기 때문에, 유사도 계산이 왜곡될 수 있습니다. 텍스트만 있는 게시글과 이미지가 포함된 게시글 사이의 유사도는 주로 텍스트 정보에 의존하게 됩니다.
        ```
### 이슈 및 해결방향
- [ ] 검정색 장지갑과 가죽소재 수첩 유사도가 높게 측정되는 부분 수정정
- [ ] 한 쪽의 게시글에만 이미지가 있는 경우 "텍스트로만 유사도를 계산" vs "이미지 유무에 따른 적응형 유사도를 계산 (가중치를 각각 설정)"